/**
 * Core Philosophy: This ruleset enforces a strict user-ownership model.
 * Each user, whether an individual or a business, can only access and modify
 * their own profile data. This prevents users from viewing or altering the
 * information of others.
 *
 * Data Structure: The data is organized into three distinct top-level
 * collections: '/users' for individual user profiles, '/businesses' for
 * business profiles, and '/products' for product listings. This segregation
 * simplifies security logic and improves query performance. User-specific data
 * uses the user's authentication UID as the document ID, creating a secure
 * path-based ownership system.
 *
 * Key Security Decisions:
 * - User Listing Disabled: To protect user privacy, listing the contents of
 *   the '/users' or '/businesses' collections is explicitly disallowed.
 * - Self-Creation Only: Users can only create a profile document for
 *   themselves, where the document ID matches their own UID.
 * - Public Product Visibility: The '/products' collection is publicly readable
 *   to allow browsing by all users, including those not signed in.
 * - Write Access to Products Restricted: All write operations (create, update,
 *   delete) on the '/products' collection are currently disabled. This is a
 *   secure default because the 'Product' entity does not yet define an
 *   ownership field (e.g., 'ownerId' or 'creatorId'), making it impossible
 *   to securely determine who should be allowed to modify product data. This
 *   will need to be updated once the data model includes ownership.
 *
 * Denormalization for Authorization: The rules rely on path-based authorization
 * where the document ID in '/users/{userId}' and '/businesses/{businessId}' is the
 * user's UID. We enforce this relationship by requiring the internal 'id'
 * field of the document to match the document ID upon creation, ensuring
 * data integrity for authorization checks.
 *
 * Structural Segregation: The use of separate top-level collections for
 * 'users', 'businesses', and 'products' provides a clear and secure boundary
 * between different types of data, preventing accidental data leakage and
 * simplifying access control logic.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ----------------------------------------------------------------------
    // Helper Functions
    // ----------------------------------------------------------------------

    /**
     * Checks if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the currently authenticated user's UID matches the provided userId.
     * This is the primary function for verifying document ownership.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * Ensures an operation is performed by the document's owner AND that the
     * document already exists. Crucial for secure update and delete operations.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    // ----------------------------------------------------------------------
    // Collection: users
    // ----------------------------------------------------------------------

    /**
     * @description Controls access to individual user profiles.
     * @path /users/{userId}
     * @allow (create) A new user (auth.uid: 'user_abc') creating their own profile at /users/user_abc.
     * @allow (get) An authenticated user (auth.uid: 'user_abc') reading their own profile from /users/user_abc.
     * @deny (list) Any user trying to list all documents in the /users collection.
     * @deny (update) A user (auth.uid: 'user_xyz') trying to update another user's profile at /users/user_abc.
     * @principle Restricts access to a user's own data tree.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(userId);
    }

    // ----------------------------------------------------------------------
    // Collection: businesses
    // ----------------------------------------------------------------------

    /**
     * @description Controls access to business user profiles.
     * @path /businesses/{businessId}
     * @allow (create) A new business user (auth.uid: 'biz_123') creating their own profile at /businesses/biz_123.
     * @allow (get) An authenticated business user (auth.uid: 'biz_123') reading their own profile from /businesses/biz_123.
     * @deny (list) Any user trying to list all documents in the /businesses collection.
     * @deny (delete) A user (auth.uid: 'user_abc') trying to delete a business profile at /businesses/biz_123.
     * @principle Restricts access to a user's own data tree.
     */
    match /businesses/{businessId} {
      allow get: if isOwner(businessId);
      allow list: if false;
      allow create: if isOwner(businessId) && request.resource.data.id == businessId;
      allow update: if isExistingOwner(businessId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(businessId);
    }

    // ----------------------------------------------------------------------
    // Collection: products
    // ----------------------------------------------------------------------

    /**
     * @description Controls access to product listings.
     * @path /products/{productId}
     * @allow (get) Any user, signed in or not, reading a product document.
     * @allow (list) Any user, signed in or not, listing all products.
     * @deny (create) Any user trying to create a new product document.
     * @deny (update) Any user trying to update an existing product document.
     * @principle Implements public read access but denies all writes as a secure default.
     */
    match /products/{productId} {
      allow get: if true;
      allow list: if true;
      // CRITICAL: Cannot implement owner-only writes. The 'Product' entity is missing an 'ownerId' or 'creatorId' field.
      // Writes are disabled to prevent unauthorized data modification.
      allow create: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
      allow update: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
      allow delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }
  }
}